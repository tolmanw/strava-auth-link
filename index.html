<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Strava Authorization â€” Troop Dashboard</title>

<style>
body {
  font-family: Arial, sans-serif;
  background: #0d1117;
  color: #e6edf3;
  text-align: center;
  padding: 30px;
  max-width: 600px;
  margin: auto;
}

button {
  padding: 12px 22px;
  font-size: 18px;
  background: #238636;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
}

button:hover { background: #2ea043; }

pre {
  background: #21262d;
  padding: 15px;
  border-radius: 8px;
  margin-top: 20px;
  font-size: 16px;
  white-space: pre-wrap;
}

pre.success {
  background: #12261a;
  border: 1px solid #238636;
  color: #3fb950;
}

pre.error {
  background: #2a1a1a;
  border: 1px solid #ff4c4c;
  color: #ff6b6b;
}

.box {
  background: #1b1f25;
  padding: 20px;
  border-radius: 12px;
  margin-top: 25px;
  text-align: left;
}

h2 { color: #58a6ff; }
</style>
</head>

<body>

<h1>Join the Troop Strava Dashboard</h1>
<p>Authorize Strava to join the dashboard.</p>

<div class="box">
  <h2>Step 1 â€” Authorise Strava</h2>
  <button id="authBtn">Authorise with Strava</button>
</div>

<div class="box">
  <h2>Step 2 â€” Your Refresh Token</h2>
  <pre id="result">Waiting for authorization...</pre>
  <button id="copyBtn" style="display:none;">Copy Refresh Token</button>
</div>

<script>
const CLIENT_ID = 188228;
const BACKEND_URL = "https://strava-auth-link.onrender.com";
const REDIRECT_URI = "https://tolmanw.github.io/strava-auth-link/";

const resultEl = document.getElementById("result");
const copyBtn = document.getElementById("copyBtn");

// Step 1 â€” Redirect to Strava
document.getElementById("authBtn").onclick = () => {
  const url =
    "https://www.strava.com/oauth/authorize" +
    `?client_id=${CLIENT_ID}` +
    "&response_type=code" +
    `&redirect_uri=${encodeURIComponent(REDIRECT_URI)}` +
    "&scope=activity:read_all" +
    "&approval_prompt=auto";

  window.location.href = url;
};

// Step 2 â€” Handle redirect
const params = new URLSearchParams(window.location.search);

// ðŸ” Robust code extraction (handles ?&code=)
let code = params.get("code");
if (!code) {
  const match = window.location.search.match(/code=([^&]+)/);
  if (match) code = match[1];
}

// Prevent double exchange
if (code && !sessionStorage.getItem("strava_used")) {
  sessionStorage.setItem("strava_used", "true");

  // Remove query params immediately
  window.history.replaceState({}, document.title, window.location.pathname);

  resultEl.textContent = "Exchanging code for refresh token...";

  fetch(`${BACKEND_URL}/exchange-code?code=${code}`)
    .then(res => {
      if (!res.ok) throw new Error("Backend error");
      return res.json();
    })
    .then(data => {
      if (data.refresh_token) {
        resultEl.textContent =
          `Athlete: ${data.name}\n\nRefresh Token:\n${data.refresh_token}`;
        resultEl.classList.add("success");

        copyBtn.style.display = "inline-block";
        copyBtn.onclick = () =>
          navigator.clipboard.writeText(data.refresh_token)
            .then(() => alert("Refresh token copied!"));
      } else {
        resultEl.textContent = "Error: " + (data.message || "Unknown error");
        resultEl.classList.add("error");
      }
    })
    .catch(err => {
      resultEl.textContent = "Error connecting to server";
      resultEl.classList.add("error");
      console.error(err);
    });
}
</script>

</body>
</html>
